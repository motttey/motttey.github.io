<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="../dist/semantic.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>

	<meta http-equiv="Content-Script-Type" content="text/javascript">
	<meta charset = "utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta author = "望月田吾作">
	<meta description = "望月 田吾作(もちづき たごさく)が描いたドラえもんをはじめとした絵や漫画の掲載を目的としたサイト.">

	<link rel="stylesheet" type="text/css" href="../dist/semantic.min.css">
	<link rel="stylesheet" type="text/css" href="../style.css" />
	<link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">


	<title>モチヅ庫</title>
	<style>
		div.line , #search-keywords{
			margin-top: 30px;
			margin-bottom: 30px;
		}
		div.boldline {
			margin-top: 50px;
			margin-bottom: 50px;
		}
		.introduction p {
			letter-spacing: 8px;
			margin-left: 20%;
			margin-right: 20%;
		}
		.main {
			margin-left: 10%;
			margin-right: 10%;
		}
	</style>
</head>

<script>

var primary_stats = {
	total_illusts: 1478,
	total_views: 4198198,
	total_bookmarks: 94505,
	total_comments: 11881,
};

function sortObjectByKey(array, key) {
	array.sort(function(a, b) {
    return (a[key] > b[key]) ? -1 : 1;
  });
	console.log(array);
	return array;
}

function showPrimaryStats(){

	/*
	d3.select(".stats")
		.selectAll("h2")
		.data(Object.entries(primary_stats))
		.append("h2")
		.attr("id", function(d,i){
			return d[0];
		})
		.text(function(d,i){
			return d[0] + ": " + d[1];
		})
	*/

	Object.entries(primary_stats).forEach(function(stat){
		var num = 0;
		setInterval(function(){
			if (num <= stat[1]){
				$('#' + stat[0]).html(stat[0] + ": " + num);
				num = num + parseInt(stat[1]/100);
			} else {
				$('#' + stat[0]).html(stat[0] + ": " + stat[1]);
			}
		},1);
	});
}

$(document).ready( function(){
	$.getJSON("output.json", function(data) {
		var DefaultIllustNum = 16;
		$('#search-mode .item')
		 .on('click', function(d) {
				$(this).addClass('active').siblings('.item').removeClass('active');
				$('div.card').remove();
				new_data = setSortTargetKey($(this).attr('id'), data);
				ViewIllust(DefaultIllustNum, new_data);
		});

		var max = 16;
		$('#search-keywords').keypress( function (e) {
			if ( e.which == 13 ) {
				query = $('#search-keywords input').val()
				output_data = [];
				data.forEach(function(illust, index){
					illust["tags"].forEach(function(tag){
						if (tag["name"].indexOf(query) != -1) {
							output_data.push(illust);
						}
					})
				})
				console.log(output_data);
				$('div.card').remove();
				ViewIllust(max, output_data);
			}
		});

		ViewIllust(DefaultIllustNum, data);
		showPrimaryStats();
	});
});

function setSortTargetKey(id, data){
	switch (id){
		case 's-random':
			break;
		case 's-bookmark':
			data = sortObjectByKey(data, 'bookmark')
			break;
		case 's-view':
			data = sortObjectByKey(data, 'view')
			break;
		case 's-comments':
			data = sortObjectByKey(data, 'comments')
			break;
	}
	return data;
}

function ViewIllust(NUM, data) {
	for(var i = 0; i < NUM; i++){
		GetRandomIllust(data, i);
	}
}

function ResizeImageHeight(id){
	// TODO: 横長画像のcrop
	var CardWidth = $("#" + id).width();
	var Cardheight = $("#" + id).height();
	var image = $("#" + id + " img");
	if (image.height() < image.width() ) {
		// $("#" + id).css("margin-top", (image.width() - image.height())/2)
	}
}

function GetRandomIllust(data, index){
	var max = data.length;	//トータルの投稿数に置換
	var min = 0;
	var ViewIllustNum = 1;
	var randomNumber = Math.random() * (max - min) + min;;
	// var illusts = $.getJSON("output.json");
	var target_data = ($('#s-random').hasClass('active'))? data[parseInt(randomNumber)] : data[index];
	var photo = "http://embed.pixiv.net/decorate.php?illust_id=" + target_data["id"];
	var url = "https://www.pixiv.net/member_illust.php?mode=medium&illust_id=" + target_data["id"];
	var id = "i" + target_data["id"];
	$('div.cards').append('  <div class="card" id="'+id+'"><div class="image"><a href="' + url + '" target="_blank"><img class="thumb-image" src="' + photo + '" \/><\/a><\/div>');
	ResizeImageHeight(id);
}
</script>

<body>

	<div class="header">
    <h1>Tagosaku Mochiduki 10th Special Site</h1>

    <h2>UNDER CONSTRUCTION</h2>
	</div>

  <div class="boldline"></div>

	<div class="main">
		<div class="stats">
			<!--
				1477
				4195893
				94469
				11880
			-->
		</div>
		<div class="introduction">
			<h2>introduction</h2>
				<p>テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト </p>
		</div>

		<div class="line"></div>

		<div class="stats">
			<h2>statics of motttey</h2>
			<!-- D3.js infographics -->
			<h1 id ="total_illusts"> </h1>
			<h1 id ="total_views"> </h1>
			<h1 id ="total_bookmarks"> </h1>
			<h1 id ="total_comments"> </h1>
		</div>

		<div class="line"></div>

		<div class="gallery">
			<h2>illust gallery</h2>

			<div class="ui four item menu" id="search-mode">
				<a class="item active" id="s-random">Random</a>
			  <a class="item" id="s-bookmark">Bookmark</a>
			  <a class="item" id="s-view">View</a>
				<a class="item" id="s-comments">Comments</a>
			</div>

			<div class="ui massive icon input" id="search-keywords">
			  <input placeholder="Search keywords..." type="text">
			  <!-- <i class="search icon"></i> -->
			</div>

			<div class="ui four stackable cards" id="gallery-cards"></div>
		</div>

		<div class="line"></div>

		<div class="stats">
			<h2>Comments</h2>
		</div>

	</div>

	<div class="boldline"></div>

  <div class="footer">
  	<p>
  		Copyright © 2008-2018 by Tagosaku Mochiduki
		</p>
		<p>
			私的利用範囲外での無断転載を禁じます.
		</p>
	</div>

</div>
