<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="../dist/semantic.min.js"></script>
	<script src="../jquery.inview/jquery.inview.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>

	<meta http-equiv="Content-Script-Type" content="text/javascript">
	<meta charset = "utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta author = "望月田吾作">
	<meta description = "望月 田吾作(もちづき たごさく)が描いたドラえもんをはじめとした絵や漫画の掲載を目的としたサイト.">

	<link rel="stylesheet" type="text/css" href="../dist/semantic.min.css">
	<link rel="stylesheet" type="text/css" href="../style.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.1/animate.min.css" />

	<link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">


	<title>モチヅ庫</title>
	<style>
		@-webkit-keyframes slide {
			from {
				margin-top: 30%;
			}
			to {
				margin-top: 0%;
			}
		}

		@keyframes slide {
			from {
				margin-top: 30%;
			}
			to {
				margin-top: 0%;
			}
		}

		/* フェードイン */
		.feedIn {
			animation: fadeIn 2s ease 0s 1 normal;
			-webkit-animation: fadeIn 2s ease 1 normal;
		}

		.slidein {
			animation-duration: 3s;
			animation-name: slide;
			-webkit-animation-duration: 3s;
			-webkit-animation-name: slide;
		}

		h2 {
			font-size: 36px;
			text-decoration: underline;
			letter-spacing: 5px;
		}

		div.line, #search-keywords, #gallery-cards{
			margin-top: 30px;
			margin-bottom: 30px;
		}

		div.boldline {
			margin-top: 50px;
			margin-bottom: 50px;
		}

		#introduction p {
			letter-spacing: 8px;
			margin-left: 20%;
			margin-right: 20%;
		}

		#main {
			margin-left: 10%;
			margin-right: 10%;
		}

		.axis path {
			stroke: white;
			stroke-width: 3px;
		}

		#stat_svg {
			width: 600px;
			height:800px;
		}

		.tick text, .labels text{
			fill: white;
			font-family: 'Passion One', cursive;
			font-size: 16px;
		}
		.tick line {
			stroke: white;
		}

		span.li_header {
			font-family: 'Passion One', cursive;
		}

		ul {
			text-align: left;
		}

		#profile img {
			width: 55%;
			height: 55%;
		}

	</style>
</head>

<script>

var selected_indexes = [];

var primary_stats = {
	total_illusts: 1478,
	total_views: 4198198,
	total_bookmarks: 94505,
	total_comments: 11881,
};

function sortObjectByKey(array, key) {
	array.sort(function(a, b) {
    return (a[key] > b[key]) ? -1 : 1;
  });
	console.log(array);
	return array;
}

function showPrimaryStats(){

	/*
	d3.select(".stats")
		.selectAll("h2")
		.data(Object.entries(primary_stats))
		.append("h2")
		.attr("id", function(d,i){
			return d[0];
		})
		.text(function(d,i){
			return d[0] + ": " + d[1];
		})
	*/

	Object.entries(primary_stats).forEach(function(stat){
		var num = 0;
		setInterval(function(){
			if (num <= stat[1]){
				$('#' + stat[0]).html(stat[0] + ": " + num);
				num = num + parseInt(stat[1]/100);
			} else {
				$('#' + stat[0]).html(stat[0] + ": " + stat[1]);
			}
		},1);
	});
}

$(document).ready( function(){
	$('img').on('inview', function(event, isInView) {
	  if (isInView) {
	    $(this).addClass('feedIn');
	  } else {
			$(this).removeClass('feedIn');
		}
	});

	$('.each_stats, #stat_svg_outer').on('inview', function(event, isInView) {
	  if (isInView) {
	    $(this).addClass('bounce');
	  } else {
			$(this).removeClass('bounce');
		}
	});

	$.getJSON("output.json", function(data) {
		var DefaultIllustNum = 16;
		$('#search-mode .item')
		 .on('click', function(d) {
				$(this).addClass('active').siblings('.item').removeClass('active');
				$('div.card').remove();
				new_data = setSortTargetKey($(this).attr('id'), data);
				ViewIllust(0, DefaultIllustNum, new_data);
		});

		$('#RandomImageViewButton')
		 .on('click', function(d) {
			 ViewIllustOnButtonClick(data);
		});

		$('#search-keywords').keypress( function (e) {
			if ( e.which == 13 ) {
				var queries = $('#search-keywords input').val().split(/\s+/)
				var queries_length = queries.length
				var output_data = [];
				selected_indexes = [];
				// キーワードの重複, 類似クエリに対応
				// 0件の時の表示検討
				data.forEach(function(illust, index){
					var matched_count = 0;
					queries.forEach(function(query){
						illust["tags"].forEach(function(tag){
							if (tag["name"].indexOf(query) != -1) {
								matched_count++;
							}
						});
					});

					if (matched_count >= queries_length) output_data.push(illust);
				});
				console.log(output_data);
				$('div.card').remove();
				var max = (output_data.length > DefaultIllustNum)? 16 :output_data.length;
				ViewIllust(0, max, output_data);
			}
		});

		ViewIllust(0, DefaultIllustNum, data);
		showPrimaryStats();
		initializeSVG();
		drawStatGraphs();
	});
});

function setSortTargetKey(id, data){
	selected_indexes = [];
	switch (id){
		case 's-random':
			break;
		case 's-bookmark':
			data = sortObjectByKey(data, 'bookmark')
			break;
		case 's-view':
			data = sortObjectByKey(data, 'view')
			break;
		case 's-comments':
			data = sortObjectByKey(data, 'comments')
			break;
	}
	return data;
}

function ViewIllustOnButtonClick(data){
		var existin_illust_num = $('div.card').length;
		var illust_num = (data.length > 4)? 4 :data.length;
		ViewIllust(existin_illust_num, illust_num, data);
}

function ViewIllust(start, NUM, data) {
	for(var i = start; i < start + NUM; i++){
		GetRandomIllust(data, i);
	}
}

function ResizeImageHeight(id){
	// TODO: 横長画像のcrop
	var CardWidth = $("#" + id).width();
	var Cardheight = $("#" + id).height();
	var image = $("#" + id + " img");
	if (image.height() < image.width() ) {
		// $("#" + id).css("margin-top", (image.width() - image.height())/2)
	}
}

function getRandomNumber(max, min){
	var randomNumber = parseInt(Math.random() * (max - min) + min);
	while(selected_indexes.includes(randomNumber)){
		randomNumber = parseInt(Math.random() * (max - min) + min);
	}
	selected_indexes.push(randomNumber);
	return randomNumber;
}

function GetRandomIllust(data, index){
	var max = data.length;	//トータルの投稿数に置換
	var min = 0;
	var ViewIllustNum = 1;
	var randomNumber = getRandomNumber(max, min);
	// var illusts = $.getJSON("output.json");
	var target_data = ($('#s-random').hasClass('active'))? data[randomNumber] : data[index];
	var photo = "http://embed.pixiv.net/decorate.php?illust_id=" + target_data["id"];
	var url = "https://www.pixiv.net/member_illust.php?mode=medium&illust_id=" + target_data["id"];
	var id = "i" + target_data["id"];
	$('div.cards').append('  <div class="card" id="'+id+'"><div class="image"><a href="' + url + '" target="_blank"><img class="thumb-image" src="' + photo + '" \/><\/a><\/div>');
	ResizeImageHeight(id);
}

function initializeSVG(){
	var width = 500;
	var height = 300;

	var bar_g = d3.select("#stat_svg").append("svg").append("g")
			.attr("id", "bar_g")
			.attr("width", width)
			.attr("height", height)
	    .attr("transform", "translate(" + 0 + "," + 0 + ")");

	var pie_g = d3.select("#stat_svg").append("svg").append("g")
			.attr("id", "pie_g")
			.attr("width", width)
			.attr("height", height)
	    .attr("transform", "translate(" + width/2 + "," + height*2 + ")");
}

function drawStatGraphs(){
	var illust_num = [
		{"year": 2008, "num": 156},
		{"year": 2009, "num": 561},
		{"year": 2010, "num": 355},
		{"year": 2011, "num": 122},
		{"year": 2012, "num": 79},
		{"year": 2013, "num": 61},
		{"year": 2014, "num": 35},
		{"year": 2015, "num": 19},
		{"year": 2016, "num": 41},
		{"year": 2017, "num": 31},
		{"year": 2018, "num": 19},
	];
	var width = 500;
	var height = 300;
	var margin = 40;
	var x_bar_scale = d3.scaleBand().rangeRound([margin, width]).padding(0.1);
  var y_bar_scale = d3.scaleLinear().rangeRound([height, margin]);

	x_bar_scale.domain(illust_num.map(function(d) { return d["year"]; }));
  y_bar_scale.domain([0, d3.max(illust_num, function(d) { return d["num"]; })]);

	var bar_g = d3.select("#bar_g");

  bar_g.append("g")
      .attr("class", "axis bar_axis-x")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x_bar_scale));

  bar_g.append("g")
      .attr("class", "axis bar_axis-y")
			.attr("transform", "translate(" + margin + "," + 0 + ")")
      .call(d3.axisLeft(y_bar_scale))
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("text-anchor", "end")
      .text("Frequency")
			.style("font-color", "white");

  bar_g.selectAll(".bar")
    .data(illust_num)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x_bar_scale(d["year"]); })
      .attr("y", function(d) { return y_bar_scale(d["num"]); })
			.attr("fill", "white")
      .attr("width", x_bar_scale.bandwidth())
      .attr("height", function(d) { return height - y_bar_scale(d["num"]); });

	var total_illust_num = [
		{"name": "my illust tagged 'doraemon'", "num": 986},
		{"name": "other illust tagged 'doraemon'", "num": 22897}
	];

	var pie_width = 300;
  var	pie_height = 300;
	var pie_radius = pie_width / 2;

	var pie = d3.pie()
		.sort(null)
		.value(function(d) {
			return d["num"];
		});

	var arc = d3.arc()
		.outerRadius(pie_radius * 0.8)
		.innerRadius(pie_radius * 0.4);

	var outerArc = d3.arc()
		.innerRadius(pie_radius * 0.9)
		.outerRadius(pie_radius * 0.9);

	var pie_g = d3.select("#pie_g");

	var pie_slices = pie_g.append("g")
		.attr("class", "slices");
	var pie_labels = pie_g.append("g")
		.attr("class", "labels");
	var pie_lines = pie_g.append("g")
		.attr("class", "lines");

	var pie_arcs = pie_slices.selectAll(".arc")
	    .data(pie(total_illust_num))
	    .enter().append("g")
	      .attr("class", "arc");

	pie_arcs.append("path")
	      .attr("d", arc)
	      .attr("fill", function(d, i) { return (i==0)? "white": "none" })
				.attr("stroke", "white");

	var pie_text = pie_labels.selectAll("text")
		.data(pie(total_illust_num))
		.enter()
		.append("text")
		.attr("dy", ".35em")
		.text(function(d) {
			return d.data["name"];
		})
    .attr("transform", function(d, i) {
			var pos = outerArc.centroid(d);
			var margin = (i%2 === 0)? -1 * 2 * pie_radius: 0.8 * pie_radius;
			pos[0] = pos[0] + margin;
			return "translate(" + pos  + ")";
		});

	var pie_polyline = pie_lines.selectAll("polyline")
				.data(pie(total_illust_num))
				.enter()
				.append("polyline")
				.attr("points", function(d, i){
						var pos = outerArc.centroid(d);
						var margin = (i%2 === 0)? -1 : 1;
						pos[0] = pie_radius * 0.5 * margin;
						return [arc.centroid(d), outerArc.centroid(d), pos];
				})
				.style("fill", "none")
				.style("stroke", "white");

	var pie_title_text = pie_g.append("svg:text")
				    .attr("dy", ".35em")
				    .attr("text-anchor", "middle")
				    .attr("style","font-family:Passion One")
				    .attr("font-size","40")
				    .attr("fill","#fff")
				    .text("parsentage of illists");
}
</script>

<body>

	<div id="header">
    <h1>Tagosaku Mochiduki 10th Special Site</h1>

    <h2>UNDER CONSTRUCTION</h2>
	</div>

  <div class="boldline"></div>

	<div id="main">
		<div id="introduction">
			<h2>introduction</h2>
				<p>テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
				</p>
				<p>
				2018.11.4
				</p>
 				<img src="img/signature.png" alt="sign" width="200"></img>
		</div>

		<div class="line"></div>

		<div id="profile">
			<h2>who is tagosaku mochiduki</h2>
			<div class="ui two column grid">
				<div class="column">
					<div class="thumbnail">
						<img src="../images/seiga.png" alt="NicoNicoSeiga"/>
					</div>
				</div>
				<div class="column">
					<div class="ui two column grid">
						<div class="column">
							<h3>Tagosaku Mochiduki a.k.a motttey</h3>
							Hyper Doraemon Creator
							<ul style="list-style-type:none">
							  <li><span class="li_header">1995</span>: 誕生</li>
							  <li><span class="li_header">2008</span>: pixiv 登録</li>
							  <li><span class="li_header">2009</span>: </li>
								<li><span class="li_header">2010</span>: 1000枚突破</li>
							  <li><span class="li_header">2011</span>: </li>
							  <li><span class="li_header">2012</span>: </li>
								<li><span class="li_header">2013</span>: </li>
							  <li><span class="li_header">2014</span>: </li>
							  <li><span class="li_header">2015</span>: </li>
								<li><span class="li_header">2016</span>: </li>
								<li><span class="li_header">2017</span>: </li>
								<li><span class="li_header">2018</span>: 10周年</li>
							</ul>
						</div>
						<div class="column">
							<h3>My Accounts</h3>
							<li><span class="li_header">Account 1</span>: </li>
							<li><span class="li_header">Account 2</span>: </li>
							<li><span class="li_header">Account 3</span>: </li>
							<li><span class="li_header">Account 4</span>: </li>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="line"></div>

		<div id="stats">
			<h2>statics of tagosaku mochiduki</h2>
			<!-- D3.js infographics -->
			<h1 id ="total_illusts" class="each_stats"> </h1>
			<h1 id ="total_views" class="each_stats"> </h1>
			<h1 id ="total_bookmarks" class="each_stats"> </h1>
			<h1 id ="total_comments" class="each_stats"> </h1>
			<div id="stat_svg_outer">
				<svg id="stat_svg"> </svg>
			</div>
		</div>

		<div class="line"></div>

		<div id="gallery">
			<h2>illust gallery</h2>

			<div class="ui four item menu" id="search-mode">
				<a class="item active" id="s-random">Random</a>
			  <a class="item" id="s-bookmark">Bookmark</a>
			  <a class="item" id="s-view">View</a>
				<a class="item" id="s-comments">Comments</a>
			</div>

			<div class="ui massive icon input" id="search-keywords">
			  <input placeholder="Search keywords..." type="text">
			  <!-- <i class="search icon"></i> -->
			</div>

			<div class="ui four stackable cards" id="gallery-cards"></div>
			<button class="ui inverted button" id="RandomImageViewButton">More</button>

		</div>

		<div class="line"></div>

		<div id="comments">
			<h2>Comments</h2>
			各界の著名人からのコメントお待ちしております
			<div id="disqus_thread">
				<script>

				/**
				*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
				*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
				/*
				var disqus_config = function () {
				this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
				this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
				};
				*/
				(function() { // DON'T EDIT BELOW THIS LINE
				var d = document, s = d.createElement('script');
				s.src = 'https://motttey.disqus.com/embed.js';
				s.setAttribute('data-timestamp', +new Date());
				(d.head || d.body).appendChild(s);
				})();
				</script>
				<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

				<script id="dsq-count-scr" src="//motttey.disqus.com/count.js" async></script>
			</div>
		</div>

	</div>

	<div class="boldline"></div>

  <div id="footer">
  	<p>
  		Copyright © 2008-2018 by Tagosaku Mochiduki
		</p>
		<p>
			私的利用範囲外での無断転載を禁じます.
		</p>
	</div>

</div>
