<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="../dist/semantic.min.js"></script>
	<script src="../jquery.inview/jquery.inview.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>

	<meta http-equiv="Content-Script-Type" content="text/javascript">
	<meta charset = "utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta author = "望月田吾作">
	<meta description = "望月 田吾作(もちづき たごさく)が描いたドラえもんをはじめとした絵や漫画の掲載を目的としたサイト.">

	<link rel="stylesheet" type="text/css" href="../dist/semantic.min.css">
	<link rel="stylesheet" type="text/css" href="../style.css" />
	<link href="https://fonts.googleapis.com/css?family=Passion+One" rel="stylesheet">


	<title>モチヅ庫</title>
	<style>
		/* フェードイン */
		.feedIn {
			animation: fadeIn 2s ease 0s 1 normal;
			-webkit-animation: fadeIn 2s ease 1 normal;
		}

		h2 {
			font-size: 36px;
			text-decoration: underline;
			letter-spacing: 5px;
		}

		div.line , #search-keywords{
			margin-top: 30px;
			margin-bottom: 30px;
		}

		div.boldline {
			margin-top: 50px;
			margin-bottom: 50px;
		}

		.introduction p {
			letter-spacing: 8px;
			margin-left: 20%;
			margin-right: 20%;
		}

		.main {
			margin-left: 10%;
			margin-right: 10%;
		}
	</style>
</head>

<script>

var selected_indexes = [];

var primary_stats = {
	total_illusts: 1478,
	total_views: 4198198,
	total_bookmarks: 94505,
	total_comments: 11881,
};

function sortObjectByKey(array, key) {
	array.sort(function(a, b) {
    return (a[key] > b[key]) ? -1 : 1;
  });
	console.log(array);
	return array;
}

function showPrimaryStats(){

	/*
	d3.select(".stats")
		.selectAll("h2")
		.data(Object.entries(primary_stats))
		.append("h2")
		.attr("id", function(d,i){
			return d[0];
		})
		.text(function(d,i){
			return d[0] + ": " + d[1];
		})
	*/

	Object.entries(primary_stats).forEach(function(stat){
		var num = 0;
		setInterval(function(){
			if (num <= stat[1]){
				$('#' + stat[0]).html(stat[0] + ": " + num);
				num = num + parseInt(stat[1]/100);
			} else {
				$('#' + stat[0]).html(stat[0] + ": " + stat[1]);
			}
		},1);
	});
}

$(document).ready( function(){
	$('img, .each_stats').on('inview', function(event, isInView) {
	  if (isInView) {
	    $(this).addClass('feedIn');
	  } else {
			$(this).removeClass('feedIn');
		}
	});

	$.getJSON("output.json", function(data) {
		var DefaultIllustNum = 16;
		$('#search-mode .item')
		 .on('click', function(d) {
				$(this).addClass('active').siblings('.item').removeClass('active');
				$('div.card').remove();
				new_data = setSortTargetKey($(this).attr('id'), data);
				ViewIllust(DefaultIllustNum, new_data);
		});

		$('#search-keywords').keypress( function (e) {
			if ( e.which == 13 ) {
				var queries = $('#search-keywords input').val().split(/\s+/)
				var queries_length = queries.length
				var output_data = [];
				selected_indexes = [];
				// キーワードの重複, 類似クエリに対応
				// 0研の時の表示検討
				data.forEach(function(illust, index){
					var matched_count = 0;
					queries.forEach(function(query){
						illust["tags"].forEach(function(tag){
							if (tag["name"].indexOf(query) != -1) {
								matched_count++;
							}
						});
					});

					if (matched_count >= queries_length) output_data.push(illust);
				});
				console.log(output_data);
				$('div.card').remove();
				var max = (output_data.length > DefaultIllustNum)? 16 :output_data.length;
				ViewIllust(max, output_data);
			}
		});

		ViewIllust(DefaultIllustNum, data);
		showPrimaryStats();
	});
});

function setSortTargetKey(id, data){
	selected_indexes = [];
	switch (id){
		case 's-random':
			break;
		case 's-bookmark':
			data = sortObjectByKey(data, 'bookmark')
			break;
		case 's-view':
			data = sortObjectByKey(data, 'view')
			break;
		case 's-comments':
			data = sortObjectByKey(data, 'comments')
			break;
	}
	return data;
}

function ViewIllust(NUM, data) {
	for(var i = 0; i < NUM; i++){
		GetRandomIllust(data, i);
	}
}

function ResizeImageHeight(id){
	// TODO: 横長画像のcrop
	var CardWidth = $("#" + id).width();
	var Cardheight = $("#" + id).height();
	var image = $("#" + id + " img");
	if (image.height() < image.width() ) {
		// $("#" + id).css("margin-top", (image.width() - image.height())/2)
	}
}

function getRandomNumber(max, min){
	var randomNumber = parseInt(Math.random() * (max - min) + min);
	while(selected_indexes.includes(randomNumber)){
		randomNumber = parseInt(Math.random() * (max - min) + min);
	}
	selected_indexes.push(randomNumber);
	return randomNumber;
}

function GetRandomIllust(data, index){
	var max = data.length;	//トータルの投稿数に置換
	var min = 0;
	var ViewIllustNum = 1;
	var randomNumber = getRandomNumber(max, min);
	// var illusts = $.getJSON("output.json");
	var target_data = ($('#s-random').hasClass('active'))? data[randomNumber] : data[index];
	var photo = "http://embed.pixiv.net/decorate.php?illust_id=" + target_data["id"];
	var url = "https://www.pixiv.net/member_illust.php?mode=medium&illust_id=" + target_data["id"];
	var id = "i" + target_data["id"];
	$('div.cards').append('  <div class="card" id="'+id+'"><div class="image"><a href="' + url + '" target="_blank"><img class="thumb-image" src="' + photo + '" \/><\/a><\/div>');
	ResizeImageHeight(id);
}
</script>

<body>

	<div class="header">
    <h1>Tagosaku Mochiduki 10th Special Site</h1>

    <h2>UNDER CONSTRUCTION</h2>
	</div>

  <div class="boldline"></div>

	<div class="main">
		<div class="stats">
			<!--
				1477
				4195893
				94469
				11880
			-->
		</div>
		<div class="introduction">
			<h2>introduction</h2>
				<p>テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト
					テストテストテストテストテストテストテストテストテストテストテストテストテストテストテストテスト </p>
				<p>
				2018.11.4
				</p>
 				<img src="img/signature.png" alt="sign" width="200"></img>
		</div>

		<div class="line"></div>

		<div class="stats">
			<h2>statics of motttey</h2>
			<!-- D3.js infographics -->
			<h1 id ="total_illusts" class="each_stats"> </h1>
			<h1 id ="total_views" class="each_stats"> </h1>
			<h1 id ="total_bookmarks" class="each_stats"> </h1>
			<h1 id ="total_comments" class="each_stats"> </h1>
		</div>

		<div class="line"></div>

		<div class="gallery">
			<h2>illust gallery</h2>

			<div class="ui four item menu" id="search-mode">
				<a class="item active" id="s-random">Random</a>
			  <a class="item" id="s-bookmark">Bookmark</a>
			  <a class="item" id="s-view">View</a>
				<a class="item" id="s-comments">Comments</a>
			</div>

			<div class="ui massive icon input" id="search-keywords">
			  <input placeholder="Search keywords..." type="text">
			  <!-- <i class="search icon"></i> -->
			</div>

			<div class="ui four stackable cards" id="gallery-cards"></div>
		</div>

		<div class="line"></div>

		<div class="stats">
			<h2>Comments</h2>
			各界の著名人からのコメントお待ちしております
			<div id="disqus_thread">
				<script>

				/**
				*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
				*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
				/*
				var disqus_config = function () {
				this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
				this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
				};
				*/
				(function() { // DON'T EDIT BELOW THIS LINE
				var d = document, s = d.createElement('script');
				s.src = 'https://motttey.disqus.com/embed.js';
				s.setAttribute('data-timestamp', +new Date());
				(d.head || d.body).appendChild(s);
				})();
				</script>
				<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

				<script id="dsq-count-scr" src="//motttey.disqus.com/count.js" async></script>
			</div>
		</div>

	</div>

	<div class="boldline"></div>

  <div class="footer">
  	<p>
  		Copyright © 2008-2018 by Tagosaku Mochiduki
		</p>
		<p>
			私的利用範囲外での無断転載を禁じます.
		</p>
	</div>

</div>
